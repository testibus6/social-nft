const nft_vote_address="0x703091392E1BEa715d9F93DaB57DAfA8bB0f45bF";var tile_size=0,epoch_px=[[0,0],[0,0]];async function getAccount(){const e=(await ethereum.request({method:"eth_requestAccounts"}))[0];console.log(e),document.getElementById("add").value=e,validated_address()}async function submitTransaction(){try{const e=await ethereum.request({method:"eth_sendTransaction",params:[{to:nft_vote_address,from:String(document.getElementById("add").value),value:web3.utils.numberToHex(web3.utils.toWei(document.getElementById("amount").value))}]});console.log(e)}catch(e){console.error(e)}}function validated_address(){try{const e=web3.utils.toChecksumAddress(document.getElementById("add").value);result=web3.utils.isAddress(e),result?document.getElementById("add").style.color="green":(console.log("unverfied address"),document.getElementById("add").style.color="red")}catch(e){console.error("invalid ethereum address",e.message),document.getElementById("add").style.color="red"}}async function submitVote(){document.getElementById("vote_loader").style.display="inline-block",data={},px_values=[];for(let e=0;e<tile_size*tile_size;e++)px_values.push(document.getElementById("px_"+String(e)).value);data.px=px_values,data.address=document.getElementById("add").value,data.amount=document.getElementById("amount").value,42==data.address.length?data.amount>0?(headers={"Content-Type":"application/json"},await fetch("https://us-central1-create-nft.cloudfunctions.net/handle_vote",{method:"POST",headers:headers,body:JSON.stringify(data)}).then(e=>e.text()).then(function(e){console.log(e),document.getElementById("vote_loader").style.display="none",document.getElementById("vote_result").style.display="block",document.getElementById("vote_result_li").style.display="block","okay"==e?(document.getElementById("transaction_details").style.display="block",document.getElementById("sendTransaction").style.display="block",document.getElementById("vote_result").innerHTML="Your vote was successfully registered. Please send the following transaction to validate your vote:",document.getElementById("from_add").innerHTML="From: "+data.address,document.getElementById("to_add").innerHTML="To: "+nft_vote_address,document.getElementById("vote_amount").innerHTML="Amount [ETH]: "+data.amount):document.getElementById("vote_result").innerHTML="Following error occured: "+e})):(document.getElementById("vote_result").style.display="block",document.getElementById("vote_result").innerHTML="Please check your amount. It seems not to be a positive number"):(document.getElementById("vote_result").style.display="block",document.getElementById("vote_result").innerHTML="Please check your address. It seems not to be a valid address")}function indicate_epoch(e){pos=0;var t=document.createElement("canvas"),n=t.getContext("2d");t.width=tile_size,t.height=tile_size;for(var o=n.getImageData(0,0,tile_size,tile_size),d=o.data,a=0;a<tile_size*tile_size;a++)a<2*tile_size||a>tile_size*tile_size-2*tile_size||a%tile_size==0||a%tile_size==1||a%tile_size==tile_size-1||a%tile_size==tile_size-2?(d[pos]=0,d[pos+1]=0,d[pos+2]=0,d[pos+3]=255):(d[pos]=255,d[pos+1]=255,d[pos+2]=255,d[pos+3]=255),pos+=4;n.putImageData(o,0,0),document.getElementById("tile_img").src=t.toDataURL(),document.getElementById("tile_img").style.left=String(epoch_px[0][0]+"px"),document.getElementById("tile_img").style.top=String(epoch_px[0][1]+"px")}function onchange_px_value(){pos=0;var e=document.createElement("canvas");e.width=tile_size,e.height=tile_size;var t=e.getContext("2d");e.width=tile_size,e.height=tile_size;for(var n=t.getImageData(0,0,tile_size,tile_size),o=n.data,d=0;d<tile_size*tile_size;d++){let e=hexToRgb(document.getElementById("px_"+String(d)).value);o[pos]=e.r,o[pos+1]=e.g,o[pos+2]=e.b,o[pos+3]=255,pos+=4}t.putImageData(n,0,0),document.getElementById("tile_img").src=e.toDataURL(),document.getElementById("tile_img").style.left=String(epoch_px[0][0]+"px"),document.getElementById("tile_img").style.top=String(epoch_px[0][1]+"px")}function rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function copyaddress(e){var t=document.getElementById(e);t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.getElementById("copied").style.color="green",setTimeout(function(){document.getElementById("copied").style.color="black"},2e3)}function check_image(e){let t=document.getElementById("file_id").files[0];var n=new FileReader;n.onload=function(e){var n=document.createElement("img");n.crossOrigin="",n.onload=function(e){var o=document.createElement("canvas");o.width=tile_size,o.height=tile_size;var d=o.getContext("2d");d.drawImage(n,0,0,tile_size,tile_size);for(var a=d.getImageData(0,0,tile_size,tile_size).data,l=0,i=0,s=a.length;i<s;i+=4)document.getElementById("px_"+String(l)).value=rgbToHex(a[i],a[i+1],a[i+2]),l+=1;var c=o.toDataURL(t.type);document.getElementById("tile_img").src=c,document.getElementById("tile_img").style.left=String(epoch_px[0][0]+"px"),document.getElementById("tile_img").style.top=String(epoch_px[0][1]+"px"),document.getElementById("tile_img").style.width=String(tile_size+"px"),document.getElementById("tile_img").style.height=String(tile_size+"px")},n.setAttribute("crossOrigin",""),n.src=e.target.result},n.readAsDataURL(t)}function create_table(e){counter=0;for(let d=0;d<e;d++){var t=document.createElement("tr");for(let d=0;d<e;d++){var n=document.createElement("td"),o=document.createElement("input");o.type="color",o.value="#e66465",o.id="px_"+String(counter),n.appendChild(o),t.appendChild(n),counter+=1}document.getElementById("vote_table").appendChild(t)}}function countdown(e){var t=setInterval(function(){var n=(new Date).getTime(),o=e-n,d=Math.floor(o/864e5),a=Math.floor(o%864e5/36e5),l=Math.floor(o%36e5/6e4),i=Math.floor(o%6e4/1e3);document.getElementById("countdown").innerHTML=d+"d "+a+"h "+l+"m "+i+"s ",o<0&&(clearInterval(t),document.getElementById("countdown").innerHTML="EXPIRED")},1e3)}async function change_main_network(){console.log("Change to ETH-network"),await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:"0x1"}]})}async function init(){void 0!==window.ethereum||void 0!==window.web3?(web3=new Web3(web3.currentProvider),web3.eth.net.getNetworkType().then(function(e){"main"!=e&&change_main_network()}),window.ethereum.on("chainChanged",function(e){window.location.reload()}),window.ethereum.on("accountsChanged",function(e){console.log("accountsChanges",e),0===e.length?console.log("Please connect to MetaMask."):document.getElementById("add").value=e[0]})):(alert("No Metamask plugin detected. Please install Metamask. Otherwise proceed carefully and manually copy the transaction details"),document.getElementById("enableEthereumButton").style.display="none",document.getElementById("sendTransaction").style.display="none",web3=new Web3),document.getElementById("nft_address").innerHTML=nft_vote_address,await fetch("./epoch.json",{method:"GET"}).then(e=>e.text()).then(function(e){const t=JSON.parse(e);if(console.log("current epoch: ",t.epoch),"epoch_"+t.epoch in t){let e=t["epoch_"+t.epoch].time.end_epoch;epoch_px=t["epoch_"+t.epoch].px,create_table(tile_size=epoch_px[1][0]-epoch_px[0][0]+1),indicate_epoch(t.epoch),document.getElementById("vote_creation").innerHTML=t.epoch,t["epoch_"+t.epoch].time.start_epoch-(new Date).getTime()>0?(delta_ms=t["epoch_"+t.epoch].time.start_epoch-(new Date).getTime(),delta_h=Math.round(delta_ms/1e3/60/60),document.getElementById("vote_creation").innerHTML="Voting for this period will open in: ~"+delta_h+" hours",document.getElementById("countdown").innerHTML="EXPIRED"):e-(new Date).getTime()<0?(next_epoch=1+t.epoch,delta_ms=Math.abs(t["epoch_"+next_epoch].time.start_epoch-(new Date).getTime()),delta_h=Math.round(delta_ms/1e3/60/60),document.getElementById("vote_creation").innerHTML="Voting for next period will open in: ~"+delta_h+" hours",document.getElementById("countdown").innerHTML="EXPIRED"):countdown(e)}else document.getElementById("nft_end").style.display="block",document.getElementById("vote_row").style.display="none",document.getElementById("final_nft").innerHTML="Voted NFT:"}),await fetch("./lead_vote.json",{method:"GET"}).then(e=>e.text()).then(function(e){const t=JSON.parse(e);document.getElementById("highestvote").innerHTML=t.amount,document.getElementById("last_update").innerHTML=create_timestamp(t.timestamp),document.getElementById("verfied_votes").innerHTML=t.verfied_votes})}function create_timestamp(e){return new Date(e).toLocaleString()}